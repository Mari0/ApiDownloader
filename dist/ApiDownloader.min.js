/*! ApiDownloader 24-06-2015 */
function ApiWrapper(a){if("ApiWrapperSettings"!=a.constructor.name)return new Error("No ApiWrapperSettings-object");var b=require("JSONPath"),c=a;this.GenerateEndpointReq=function(){var a=null,b=c.api.endpoints[c.endpoint];if(b){var e=null;e=-1!=b.path.indexOf("{"+b.identifier+"}")?b.path.replace("{"+b.identifier+"}",c.identifier):b.path,a=c.api.basePath+e,a=d(a,b.required_parameters,c.reqParam,!0),a=d(a,b.optional_parameters,c.optParam)}return a};var d=function(a,b,d,f){var g=e(d);if(b){a+=-1!=a.indexOf("?")?"&":"?";for(var h in b)if(b.hasOwnProperty(h))if("@apiKey"===b[h])a+=h+"="+c.api.apiKey+"&";else if("@user"===b[h]){if(null!=g&&null!=g[h])a+=h+"="+g[h]+"&";else if(f)throw new Error("Request is not correct! Missing required parameters")}else a+=h+"="+b[h]+"&";a=a.slice(0,-1)}return a},e=function(a){if(a){var b={},c=a.replace("--reqParam:","").replace("--optParam:",""),d=c.split(";");return d.forEach(function(a){var c=a.split("=");b[c[0]]=c[1]}),b}};this.GetAdditionalReq=function(a,c){var e=!1;if(c.request_condition?f(c.request_condition,a)&&(e=!0):e=!0,e){var g=b.eval(a,c.jsonPath)[0];return g=d(g,c.required_parameters,null),g=d(g,c.optional_parameters,null)}return null};var f=function(a,c){if(-1!=a.search(/\w\ (>|=|>=|<|<=|!=)\ \w/g)){var d=a.split(/\ (>|=|>=|<|<=|!=)\ /g),e=b.eval(c,d[0])[0],f=parseInt(d[2]);switch("number"!=typeof f&&(f=d[2]),a.match(/(>|=|>=|<|<=|!=)/g)[0]){case">":return e>f;case">=":return e>=f;case"<":return f>e;case"<=":return f>=e;case"=":return e==f;case"!=":return e!=f}}}}function ApiWrapperSettings(a,b,c,d,e,f){this.options=f?f:"",this.api=a,this.endpoint=b,this.identifier=c,this.reqParam=d,this.optParam=e}exports.ApiWrapper=ApiWrapper,exports.ApiWrapperSettings=ApiWrapperSettings,exports.Downloader=function(a,b,c,d,e,f){var g=require("cron").CronJob,h=exports.RunApiWrapper,i=0;(!c||1>c)&&(c=b.length),new g(d,function(){for(var d=0;c>d&&i<b.length;d++){a.identifier=b[i];var f=h(a,function(a,b){e(a,b)});f&&"Error"===f.constructor.name&&console.log(f),i++,i==b.length&&this.stop()}},f,!0)},exports.SimpleDownloader=function(a,b,c,d,e,f){var g=require("cron").CronJob,h=require("request"),i=require("q"),j=function(a,b){var c=i.defer(),d=null;return d="Object"===a.constructor.name&&b?a[b]:a,h.get(d,function(b,d,e){c.resolve({body:e,meta:a})}),c.promise},k=0;(!c||1>c)&&(c=a.length),new g(d,function(){for(var d=0;c>d&&k<a.length;d++)j(a[k],b).then(function(a){e(a.body,a.meta)}),k++,k==a.length&&this.stop()},f,!0)},exports.Shedule=function(a,b,c,d,e,f,g,h,i){var j=require("cron").CronJob;new j(a,function(){c(d,e,f,g,h,i)},b,!0)};var Done=function(a,b){setTimeout(function(){return a.Requests.length<a.amountOfRequest?void Done(a,b):void b()},1e3)};exports.RunApiWrapper=function(a,b){var c=(require("fs"),function(a,b){var c=null;c=require(-1!=a.indexOf("https")?"https":"http");var d=[];c.get(a,function(a){a.on("data",function(a){d.push(a)}),a.on("end",function(){b(d.join("").toString(),a.statusCode)})}).on("error",function(a){b(a.message)})}),d={},e=new ApiWrapperSettings,f="";if(e=a,!a.api)return new Error("no API defined!");if(!a.endpoint)return new Error("Error:No Endpoint defined!");if(e.api.endpoints[e.endpoint].identifier){if(!e.identifier)return new Error("Identifier is missing");d.Id=e.identifier}else f=a.identifier;var g=new ApiWrapper(e),h=g.GenerateEndpointReq();if(!h)return void console.error("no valid request");var i={},j=[];d.Requests=j;var k=1;d.amountOfRequest=k,-1==e.options.indexOf("n")?c(h,function(a,f){var l=[],m=null;try{m=JSON.parse(a,"utf8")}catch(n){return void b(d,{error:!0,error_msg:"error:parsing to json failed!",data:a})}var o=JSON.stringify(m);j.push({req:h,status:f}),i.root_data=o,e.api.endpoints[e.endpoint].additionalRequest&&e.api.endpoints[e.endpoint].additionalRequest.forEach(function(a){var b=g.GetAdditionalReq(m,a);b?(d.amountOfRequest=++k,-1==e.options.indexOf("a")?c(b,function(c,d){try{var e=JSON.parse(c,"utf-8");i[a.name]=JSON.stringify(e),j.push({req:b,status:d,name:a.name})}catch(f){i[a.name]=JSON.stringify({error:!0,error_msg:"ERROR: parsing to json failed!",status:d,data:c}),j.push({req:b,status:d,name:a.name,error:!0})}}):j.push({req:b,status:"not requested",name:a.name})):l.push(a.name)}),d.falsyConditions=l,-1==e.options.indexOf("a")?Done(d,function(){b&&b(d,i)}):b&&b(d,i)}):(console.log("Http Request deactivated!!"),j.push({req:h,status:"not requested"}),b&&b(d))};